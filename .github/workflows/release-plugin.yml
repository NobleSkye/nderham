name: Build and Release Plugin

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g., v1.0.0 or 1.0.0)'
        required: true
        type: string
      prerelease:
        description: 'Mark as pre-release'
        required: false
        type: boolean
        default: false

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven
        
    - name: Extract version from tag
      id: extract-version
      run: |
        TAG="${{ inputs.tag }}"
        # Remove 'v' prefix if present
        VERSION="${TAG#v}"
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "tag=v$VERSION" >> $GITHUB_OUTPUT
        echo "Extracted version: $VERSION"
        echo "Git tag will be: v$VERSION"
        
    - name: Update version in pom.xml
      if: hashFiles('**/pom.xml') != ''
      run: |
        mvn versions:set -DnewVersion=${{ steps.extract-version.outputs.version }}
        mvn versions:commit
        
    - name: Update version in build.gradle
      if: hashFiles('**/pom.xml') == '' && hashFiles('**/build.gradle') != ''
      run: |
        sed -i "s/version = .*/version = '${{ steps.extract-version.outputs.version }}'/" build.gradle
        
    - name: Build with Maven
      if: hashFiles('**/pom.xml') != ''
      run: mvn -B clean package --file pom.xml
      
    - name: Build with Gradle
      if: hashFiles('**/pom.xml') == '' && hashFiles('**/build.gradle') != ''
      run: ./gradlew clean build
      
    - name: Find plugin JAR
      id: find-jar
      run: |
        if [ -d target ]; then
          JAR_PATH=$(find target -name "*.jar" -not -name "*-sources.jar" -not -name "*-javadoc.jar" | head -n 1)
        elif [ -d build/libs ]; then
          JAR_PATH=$(find build/libs -name "*.jar" | head -n 1)
        else
          echo "No JAR file found!"
          exit 1
        fi
        
        if [ -z "$JAR_PATH" ]; then
          echo "No JAR file found!"
          exit 1
        fi
        
        echo "jar_path=$JAR_PATH" >> $GITHUB_OUTPUT
        echo "jar_name=$(basename $JAR_PATH)" >> $GITHUB_OUTPUT
        echo "Found JAR: $JAR_PATH"
        
    - name: Upload plugin artifact
      uses: actions/upload-artifact@v3
      with:
        name: ResourcePackPlugin-${{ steps.extract-version.outputs.version }}
        path: ${{ steps.find-jar.outputs.jar_path }}
        if-no-files-found: error
        
    - name: Create Git Tag
      run: |
        git config user.name "GitHub Actions Bot"
        git config user.email "actions@github.com"
        git tag -a "${{ steps.extract-version.outputs.tag }}" -m "Release version ${{ steps.extract-version.outputs.version }}"
        git push origin "${{ steps.extract-version.outputs.tag }}"
        
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.extract-version.outputs.tag }}
        name: ResourcePackPlugin v${{ steps.extract-version.outputs.version }}
        files: ${{ steps.find-jar.outputs.jar_path }}
        body: |
          # Resource Pack Plugin v${{ steps.extract-version.outputs.version }}
          
          Minecraft plugin for scoreboard-based resource pack assignment.
          
          ## Installation
          1. Download the JAR file below
          2. Place it in your server's `plugins/` folder
          3. Restart the server
          4. Configure resource packs in `plugins/ResourcePackPlugin/config.yml` or use JSON files in datapacks
          
          ## Features
          - ✅ `/resourcepack set <pack_name>` command with tab completion
          - ✅ `doAutoResourcepackReload` gamerule (true/false)
          - ✅ JSON configuration support (compatible with datapack configs)
          - ✅ SHA-256 hash verification
          - ✅ Auto mode: Automatic pack assignment on scoreboard changes
          - ✅ Manual mode: Command-based pack application
          - ✅ Full selector support (@a, @p, @s, @r, @e)
          - ✅ Multi-namespace configuration
          - ✅ Reload support with `/reload` command
          
          ## Commands
          - `/resourcepack set <pack_name>` - Apply a resource pack to yourself or selected players
          - `/resourcepack reload` - Reload configuration files
          - `/resourcepack list` - List available resource packs
          - `/resourcepack help` - Show help information
          
          ## Gamerules
          - `/gamerule doAutoResourcepackReload true|false` - Enable/disable auto mode
          
          ## Configuration
          Edit `plugins/ResourcePackPlugin/config.yml` or create JSON files in your datapack's `data/<namespace>/resourcepack.json`
          
          ## Requirements
          - Minecraft Server 1.20.x or higher
          - Spigot or Paper server
          - Java 17 or higher
          
          ## Support
          For issues and questions, visit the [GitHub repository](https://github.com/NobleSkye/nderham)
        draft: false
        prerelease: ${{ inputs.prerelease }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
